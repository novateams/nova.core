---
- name: Saving following autogenerated secret(s) to {{ secrets_vault_engine_path }}/{{ secrets_vault_secrets_path }}...
  ansible.builtin.uri:
    url: "{{ secrets_vault_data_fullpath }}"
    method: PATCH
    headers:
      X-Vault-Request: true
      X-Vault-Token: "{{ vault_access_token | default(auth.json.auth.client_token) }}"
      Content-Type: application/merge-patch+json
    body: "{{ {'data': {autogen_secret.key: (autogen_secret.value | default(secrets_to_vault_autogenerated_key_secret))}} }}"
    body_format: json
    validate_certs: "{{ validate_vault_certs }}"
  delegate_to: localhost
  become: false
  when: autogenerated_secret or autogen_secret.autogenerated_secret | default(false)
  loop: "{{ secrets }}"
  loop_control:
    loop_var: autogen_secret
    label: "{{ autogen_secret.key }}"

- name: Saving following secret(s) to {{ secrets_vault_engine_path }}/{{ secrets_vault_secrets_path }}...
  ansible.builtin.uri:
    url: "{{ secrets_vault_data_fullpath }}"
    method: PATCH
    headers:
      X-Vault-Request: true
      X-Vault-Token: "{{ vault_access_token | default(auth.json.auth.client_token) }}"
      Content-Type: application/merge-patch+json
    body: "{{ {'data': {pregenerated_secret.key: (pregenerated_secret.value | default(secrets_to_vault_autogenerated_key_secret))}} }}"
    body_format: json
    validate_certs: "{{ validate_vault_certs }}"
  delegate_to: localhost
  become: false
  when:
    - pregenerated_secret.key not in existing_secrets.json.data.data
    - not autogenerated_secret or not pregenerated_secret.autogenerated_secret | default(false)
  loop: "{{ secrets }}"
  loop_control:
    loop_var: pregenerated_secret
    label: "{{ pregenerated_secret.key }}"
