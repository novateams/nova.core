---
- name: Adding {{ autogen_secret.key }} secret to {{ secrets_vault_secrets_path }}...
  ansible.builtin.uri:
    url: "{{ secrets_vault_data_fullpath }}"
    method: PATCH
    headers:
      X-Vault-Request: true
      X-Vault-Token: "{{ auth.json.auth.client_token }}"
      Content-Type: application/merge-patch+json
    body:
      data: '{ "{{ autogen_secret.key }}": "{{ autogen_secret.value }}" }'
    body_format: json
    validate_certs: "{{ validate_vault_certs }}"
  delegate_to: localhost

- name: Checking if the key {{ autogen_secret.key }} was successfully added...
  ansible.builtin.uri:
    url: "{{ secrets_vault_data_fullpath }}"
    method: GET
    headers:
      X-Vault-Request: true
      X-Vault-Token: "{{ auth.json.auth.client_token }}"
    body_format: json
    validate_certs: "{{ validate_vault_certs }}"
  register: autogen_post_add_check
  delegate_to: localhost

- name: Re-including add_autogenerated_secrets task...
  ansible.builtin.include_tasks: add_autogenerated_secrets.yml
  when: autogen_secret.key not in autogen_post_add_check.json.data.data
