---
# The commented out body can be used when moving to Ansible >= 2.19
- name: Saving following user(s) passwords to {{ secrets_vault_engine_path }}/{{ secrets_vault_secrets_path }}...
  ansible.builtin.uri:
    url: "{{ secrets_vault_data_fullpath }}"
    method: PATCH
    headers:
      X-Vault-Request: true
      X-Vault-Token: "{{ vault_access_token | default(auth.json.auth.client_token) }}"
      Content-Type: application/merge-patch+json
    # body: "{{ {'data': {account_key_name: (account.password | default(secrets_to_vault_autogenerated_account_secret))}} }}"
    body:
      "{{ {'data': {account_key_name: (secrets_to_vault_autogenerated_account_secret if account.password is not defined or account.password
      | regex_search('.*__omit_place_holder__.*') else account.password)}} }}"
    body_format: json
    validate_certs: "{{ validate_vault_certs }}"
  when:
    - account.save_password_to_vault | default(true)
    - account_key_name not in existing_secrets.json.data.data
  delegate_to: localhost
  become: false
  loop: "{{ accounts }}"
  loop_control:
    loop_var: account
    label: "{{ account.username }}"
