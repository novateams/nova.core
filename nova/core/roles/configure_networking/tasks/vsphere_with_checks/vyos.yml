---
- name: Configuring VyOS networking...
  become: false
  delegate_to: localhost
  block:
    - name: Wiping all interfaces script...
      ansible.builtin.include_tasks: util/upload_file.yml
      loop:
        - name: vyos-wipe.sh
          src: vyos-wipe.sh
          dest: /home/vyos/vyos-wipe.sh

    - name: Running wiping all interfaces script...
      ansible.builtin.include_tasks: util/send_cmd.yml
      vars:
        bin_to_execute: /bin/vbash
        args_to_execute: /home/vyos/vyos-wipe.sh

    ### Interfaces will get autogenerated again
    - name: Rebooting {{ custom_vm_name | default(vm_name) }}...
      vmware.vmware_rest.vcenter_vm_guest_power:
        state: reboot
        vm: "{{ created_vm_info.value[0].vm | default(vcenter_vm_info.value[0].vm) }}"
      delegate_to: localhost
      become: false

    - name: Wait for reboot...
      ansible.builtin.wait_for:
        timeout: 60

    - name: Uploading VyoS configuration script...
      ansible.builtin.include_tasks: util/upload_file.yml
      loop:
        - name: firstconfig.sh
          src: config.boot
          dest: /home/vyos/firstconfig.sh

    - name: Running VyoS configuration script...
      ansible.builtin.include_tasks: util/send_cmd.yml
      vars:
        bin_to_execute: /bin/vbash
        args_to_execute: /home/vyos/firstconfig.sh
