network:
  version: 2
  {% if netplan_renderer != {} %}
  renderer: {{ netplan_renderer }}
  {% endif %}
  ethernets:
  {% for interface in interfaces %}
  {% set interface_loop = loop.index0 %}
    {{ interface_names[interface_loop] }}:
      set-name: {{ interface_names[interface_loop] }}
      match:
        macaddress: {{ configure_networking_mac_addresses[interface_loop] }}
      {% if interface.addresses == [] %}
      dhcp4: true
      dhcp6: true
      accept-ra: true
      {% else %}
      dhcp4: {{ true | lower if interface.addresses | map(attribute='mode') | intersect(['ipv4_dhcp']) else false | lower }}
      dhcp6: {{ true | lower if interface.addresses | map(attribute='mode') | intersect(['ipv6_dhcp','ipv6_slaac']) else false | lower }}
      accept-ra: {{ true | lower if interface.addresses | map(attribute='mode') | intersect(['ipv6_dhcp','ipv6_slaac']) else false | lower }}
      {% if interface.addresses | map(attribute='mode') | intersect(['ipv4_static', 'ipv6_static']) | list | length > 0 %}
      addresses:
        {% for ip_address in interface.addresses %}
        {% if ip_address.address != none %}
        - {{ ip_address.address }}
        {% endif %}
        {% endfor %}
        {% if extra_ipv4[interface_names[interface_loop]] is defined %}
        {% for ipv4 in extra_ipv4[interface_names[interface_loop]] %}
        - {{ ipv4 }}
        {% endfor %}
        {% endif %}
        {% if extra_ipv6[interface_names[interface_loop]] is defined %}
        {% for ipv6 in extra_ipv6[interface_names[interface_loop]] %}
        - {{ ipv6 }}
        {% endfor %}
        {% endif %}
      {% endif %}
      {% if (interface.addresses | selectattr("gateway", "!=", none)) or (extra_routes[interface_names[interface_loop]] is defined) %}
      routes:
      {% endif %}
      {% for ip_address in interface.addresses %}
      {% if (ip_address.mode == "ipv4_static") and (ip_address.gateway is defined) and (ip_address.gateway != none) %}
        - to: default
          via: "{{ ip_address.gateway }}"
      {% endif %}
      {% endfor %}
      {% for ip_address in interface.addresses %}
      {% if (ip_address.mode == "ipv6_static") and (ip_address.gateway is defined) and (ip_address.gateway != none) %}
        - to: default
          via: "{{ ip_address.gateway }}"
      {% endif %}
      {% endfor %}
      {% if extra_routes[interface_names[interface_loop]] is defined %}
      {% for route in extra_routes[interface_names[interface_loop]] %}
        - to: {{ route.to }}
          via: "{{ route.via }}"
      {% endfor %}
      {% endif %}
      {% if extra_ipv4 is defined or extra_ipv6 is defined %}
      {{ '# Since one of the interfaces contains multiple IP addresses,' }}
      {{ '# The DNS servers are configured in /etc/resolv.conf' }}
      {% else %}
      {% if ((interface.connection) or (interface.egress)) and (dns_server_combined != []) %}
      nameservers:
        addresses:
          {% if (dns_servers != []) and (interface.addresses | map(attribute='mode') | regex_search(".*ipv4.*")) %}
          {% for address in dns_servers %}
          - {{ address }}
          {% endfor %}
          {% endif %}
          {% if (dns_servers6 != []) and (interface.addresses | map(attribute='mode') | regex_search(".*ipv6.*")) %}
          {% for address in dns_servers6 %}
          - {{ address }}
          {% endfor %}
          {% endif %}
        search:
          - {{ domain }}
      {% endif %}
      {% endif %}
      {% endif %}
  {% endfor %}
