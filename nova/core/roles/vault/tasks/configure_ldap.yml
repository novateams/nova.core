---
- name: Getting all mounts...
  ansible.builtin.uri:
    url: "{{ vault_configuration_uri }}/v1/sys/auth"
    method: GET
    headers:
      X-Vault-Request: true
      X-Vault-Token: "{{ vault_root_token }}"
    body_format: json
    validate_certs: "{{ vault_validate_cert }}"
  register: all_auth_methods

# vault_ldap_engine_name + '/' is required to match the strange output that comes from all_auth_methods.json.data
- name: Configuring LDAP auth engine...
  ansible.builtin.uri:
    url: "{{ vault_configuration_uri }}/v1/sys/auth/ldap{{ '/tune' if vault_ldap_engine_name + '/' in all_auth_methods.json.data else '' }}"
    method: POST
    headers:
      X-Vault-Request: true
      X-Vault-Token: "{{ vault_root_token }}"
    body:
      config:
        token_type: default-service
      path: ldap
      type: ldap
    body_format: json
    validate_certs: "{{ vault_validate_cert }}"
    status_code:
      - 204

- name: Setting LDAP auth as default engine...
  ansible.builtin.uri:
    url: "{{ vault_configuration_uri }}/v1/sys/auth/ldap/tune"
    method: POST
    headers:
      X-Vault-Request: true
      X-Vault-Token: "{{ vault_root_token }}"
    body:
      listing_visibility: unauth
    body_format: json
    validate_certs: "{{ vault_validate_cert }}"
    status_code:
      - 204

- name: Getting /etc/ssl/certs/ca-certificates.crt contents for LDAPs...
  ansible.builtin.slurp:
    path: /etc/ssl/certs/ca-certificates.crt
  register: vault_ldaps_certificate_file

- name: Configuring LDAP...
  ansible.builtin.uri:
    url: "{{ vault_configuration_uri }}/v1/auth/ldap/config"
    method: POST
    headers:
      X-Vault-Request: true
      X-Vault-Token: "{{ vault_root_token }}"
    body: "{{ vault_ldap_configuration }}"
    body_format: json
    validate_certs: "{{ vault_validate_cert }}"
    status_code:
      - 204
