---
- name: Making sure locale exists...
  community.general.locale_gen:
    name: en_US.UTF-8
    state: present

- name: Adding nexus source.list...
  block:
    - name: For Kali
      ansible.builtin.template:
        src: kali-sources.list
        dest: /etc/apt/sources.list
      when: "'os_kali_latest' in group_names"

    - block:
        - name: For Parrot 1/2
          ansible.builtin.template:
            src: parrot-sources-1.list
            dest: /etc/apt/sources.list
        - name: For Parrot 2/2
          ansible.builtin.template:
            src: parrot-sources-2.list
            dest: /etc/apt/sources.list.d/parrot.list
      when: "'os_parrot_latest' in group_names"

    - name: For Ubuntu
      ansible.builtin.template:
        src: ubuntu-sources.list
        dest: /etc/apt/sources.list
      when: "'os_ubuntu' in group_names"

    - name: For Debian
      ansible.builtin.template:
        src: debian-sources.list
        dest: /etc/apt/sources.list
      when: "'os_debian' in group_names"
  when: nexus_fqdn is defined and nexus_fqdn is not none

- name: Allow release-info to change for APT repositories
  ansible.builtin.command: apt-get update -y --allow-releaseinfo-change
  when: internet_connected

- name: Refresh APT sources
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 600
  when: internet_connected
