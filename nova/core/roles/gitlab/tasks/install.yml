---
- name: Creating Gitlab folders..
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    recurse: true
  loop:
    - "{{ gitlab_config_folder }}"
    - "{{ gitlab_config_folder }}/etc"
    - "{{ gitlab_config_folder }}/data"
    - "{{ gitlab_config_folder }}/logs"
    - "{{ gitlab_config_folder }}/registry"
    - "{{ gitlab_config_folder }}/temp_configuration"

- name: Templating Gitlab configuration files for {{ inventory_hostname }}..
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode | default('0644') }}"
    lstrip_blocks: true
  loop:
    - src: gitlab.yml
      dest: "{{ gitlab_config_folder }}/docker-compose.yml"
    - src: gitlab.rb
      dest: "{{ gitlab_config_folder }}/gitlab.rb"
    - src: increase-maxauthtries.sh
      dest: "{{ gitlab_config_folder }}/increase-maxauthtries.sh"
      mode: "0755"

# Using separate retries because currently wait_timeout does not work
# Leaving wait_timeout for future use
- name: Composing Gitlab on {{ inventory_hostname }}...
  community.docker.docker_compose_v2:
    project_src: "{{ gitlab_config_folder }}"
    state: present
    wait: true
    wait_timeout: 600
  register: gitlab_compose
  until:
    - gitlab_compose.containers[0].Health is defined
    - gitlab_compose.containers[0].Health == 'healthy'
  retries: 20
  delay: 30

- name: Increasing GitLab ssh MaxAuthTries to {{ gitlab_ssh_max_auth_tries }}..
  community.docker.docker_container_exec:
    container: gitlab
    command: /srv/increase-maxauthtries.sh
  register: increase_maxauthtries

# This is required to apply the changes from the increase-maxauthtries.sh script
# Stop and start are used instead of restart because restart to avoid timeouts on low end machines
- name: Stopping and starting GitLab container to apply changes..
  when: increase_maxauthtries.stdout == "added"
  block:
    - name: Stopping Gitlab on {{ inventory_hostname }}...
      community.docker.docker_compose_v2:
        project_src: "{{ gitlab_config_folder }}"
        state: stopped
        wait: true

    - name: Starting Gitlab on {{ inventory_hostname }}...
      community.docker.docker_compose_v2:
        project_src: "{{ gitlab_config_folder }}"
        state: present
        wait: true
        wait_timeout: 600
      register: gitlab_recompose
      until:
        - gitlab_recompose.containers[0].Health is defined
        - gitlab_recompose.containers[0].Health == 'healthy'
      retries: 20
      delay: 30

- name: Finding and restarting proxy container..
  when: gitlab_proxy_container_name != {}
  block:
    - name: Checking if the proxy container exists..
      community.docker.docker_container_info:
        name: "{{ gitlab_proxy_container_name }}"
      register: proxy_container_check

    - name: Restarting {{ gitlab_proxy_container_name }}..
      community.docker.docker_container:
        name: "{{ gitlab_proxy_container_name }}"
        state: started
        restart: true
        container_default_behavior: no_defaults
      when: proxy_container_check.exists
