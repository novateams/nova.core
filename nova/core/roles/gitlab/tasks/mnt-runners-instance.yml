---
- name: Create an instance runner {{ runner.meta_name | default('') }}..
  ansible.builtin.uri:
    url: "{{ gitlab_url_api }}/user/runners"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_root_personal_token }}"
    body_format: json
    body:
      runner_type: instance_type
      description: "{{ runner.description }}"
      paused: "{{ runner.paused | default(false) }}"
      run_untagged: "{{ runner.run_untagged | default(true) }}"
      tag_list: "{{ runner.tags | default([]) }}"
      access_level: "{{ runner.access_level | default('ref_protected') }}"
    status_code: 201
  register: gl_created_runner
  when: runner.description not in gl_existing_runners.json | map(attribute="description")

- name: Store the token value in vault..
  ansible.builtin.include_role:
    name: nova.core.secrets_to_vault
  when:
    - gl_created_runner.json.token is defined
    - gl_created_runner.status == 201
    - gl_created_runner.status is defined
  vars:
    autogenerated_secret: true
    secrets:
      - key: "{{ inventory_hostname }}_instance_runner_pat_{{ runner.name }}"
        value: "{{ gl_created_runner.json.token }}"
