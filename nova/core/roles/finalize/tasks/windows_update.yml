---
- name: Disabling Windows Update...
  when: disable_windows_update
  block:
    - name: Setting following Windows Update disable registry values...
      ansible.windows.win_regedit:
        path: "{{ item.path }}"
        name: "{{ item.name }}"
        data: "{{ item.data }}"
        type: "{{ item.type }}"
      loop_control:
        label: Setting {{ item.name }} to {{ item.data }}
      loop:
        # Wsus config
        - name: SetDisableUXWUAccess
          data: 1
          path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
          type: dword

        - name: DoNotConnectToWindowsUpdateInternetLocations
          data: 1
          path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
          type: dword

        - name: NoAutoUpdate
          data: 1
          path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU
          type: dword

        - name: WindowsUpdateDisableCustomValue
          data: 1
          path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
          type: dword

    - name: Stopping prefetch...
      ansible.windows.win_service:
        name: SysMain
        state: stopped

    - name: Stopping Windows Update service...
      ansible.windows.win_service:
        name: wuauserv
        state: stopped
      register: disable_windows_update_service
      until: not disable_windows_update_service.failed
      retries: 5
      delay: 3

    # Greater than Windows 8.1 & Server 2012 R2
    - name: Stopping Update Orchestrator Service...
      ansible.windows.win_service:
        name: UsoSvc
        state: stopped
      when: ansible_facts['distribution_version'] is version('6.3.9600.0', '>')

    # Removing Windows Update cache using rd because Powershell (win_file module) can't do it in some cases although it's possible manually
    # The issue is most likely related to long paths
    - name: Removing C:\Windows\SoftwareDistribution...
      ansible.windows.win_shell: if ((Test-Path "C:\Windows\SoftwareDistribution") -eq $true) {cmd /c rd C:\Windows\SoftwareDistribution /S /Q}
      register: remove_win_update_cache
      until: not remove_win_update_cache.failed
      retries: 5
      delay: 3

- name: Removing Windows Update disable registry values...
  when: not disable_windows_update
  block:
    - name: Checking if WindowsUpdateDisableCustomValue exists...
      ansible.windows.win_reg_stat:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate
        name: WindowsUpdateDisableCustomValue
      register: windows_update_disable_flag

    - name: Re-enabling Windows...
      when: windows_update_disable_flag.exists
      block:
        - name: Removing following Windows Update disable registry values...
          ansible.windows.win_regedit:
            path: "{{ item.path }}"
            name: "{{ item.name }}"
            state: absent
          loop_control:
            label: Removing {{ item.name }}...
          loop:
            # Wsus config
            - name: SetDisableUXWUAccess
              path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate

            - name: DoNotConnectToWindowsUpdateInternetLocations
              path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate

            - name: NoAutoUpdate
              path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU

            - name: WindowsUpdateDisableCustomValue
              path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate

        - name: Restarting Windows Update service...
          ansible.windows.win_service:
            name: wuauserv
            state: restarted
          register: disable_windows_update_service
          until: not disable_windows_update_service.failed
          retries: 5
          delay: 3

        # Greater than Windows 8.1 & Server 2012 R2
        - name: Restarting Update Orchestrator Service...
          ansible.windows.win_service:
            name: UsoSvc
            state: restarted
          when: ansible_facts['distribution_version'] is version('6.3.9600.0', '>')
