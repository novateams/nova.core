---
- name: Creating a live snapshot...
  ansible.builtin.shell: DISPLAY={{ lookup('env', 'DISPLAY') }} vmrun -T ws snapshot {{ local_vmx_path }} {{ snapshot_name | default(ansible_date_time.iso8601) }}
  when: live_snap

- block:
    - name: Listing running VMs...
      shell: DISPLAY={{ lookup('env', 'DISPLAY') }} vmrun -T ws list
      register: running_vms

    - name: Stopping {{ inventory_hostname }}...
      shell: DISPLAY={{ lookup('env', 'DISPLAY') }} vmrun -T ws stop {{ local_vmx_path }} soft
      when: local_vmx_path in running_vms.stdout_lines

    - name: Removing all existing snapshots...
      ansible.builtin.shell: DISPLAY={{ lookup('env', 'DISPLAY') }} vmrun -T ws deleteSnapshot {{ local_vmx_path }} {{ all_snapshots.stdout_lines[1] }} andDeleteChildren #[1] because the first item in the list is title
      when: snapshot_mode == 're-snap'

    - name: Creating a snapshot...
      ansible.builtin.shell: DISPLAY={{ lookup('env', 'DISPLAY') }} vmrun -T ws snapshot {{ local_vmx_path }} {{ snapshot_name | default(ansible_date_time.iso8601) }}

    - name: Starting {{ inventory_hostname }}...
      shell: DISPLAY={{ lookup('env', 'DISPLAY') }} vmrun -T ws start {{ local_vmx_path }}

  when: not live_snap
