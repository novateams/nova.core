---
- block:
    - name: Removing all existing snapshots...
      community.vmware.vmware_guest_snapshot:
        datacenter: "{{ datacenter }}"
        folder: "{{ folder }}"
        name: "{{ custom_vm_name | default(vm_name) }}"
        state: remove_all
      when: snapshot_mode == 'resnap'

    - name: Creating a snapshot...
      community.vmware.vmware_guest_snapshot:
        datacenter: "{{ datacenter }}"
        folder: "{{ folder }}"
        name: "{{ custom_vm_name | default(vm_name) }}"
        state: present
        memory_dump: "{{ true if snapshot_mode == 'live-snap' else false }}"
        snapshot_name: "{{ snapshot_name }}"
        description: "{{ snapshot_description }}"
  delegate_to: localhost
  become: false

- name: Including powerstate role...
  include_role:
    name: nova.core.powerstate
  vars:
    poweron: true
  when:
    - start_vm_after_snapshot | bool # Because CLI detects extra var as string
    - snapshot_mode != 'live-snap'
